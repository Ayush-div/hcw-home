<div class="practitioner-consultation-room">
  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-container">
    <div class="loading-spinner"></div>
    <h3>Connecting to consultation...</h3>
    <p>Please wait while we set up your consultation room</p>
  </div>

  <!-- Error State -->
  <div *ngIf="error && !isLoading" class="error-container">
    <div class="error-icon">⚠️</div>
    <h3>Connection Error</h3>
    <p>{{ error }}</p>
    <button class="btn btn-primary" (click)="leaveConsultation()">
      Back to Dashboard
    </button>
  </div>

  <!-- Main Consultation Interface -->
  <div *ngIf="!isLoading && !error" class="consultation-interface">
    <!-- Header -->
    <header class="consultation-header">
      <div class="header-left">
        <h2>Consultation Room</h2>
        <div class="consultation-info">
          <span
            class="status-indicator"
            [class]="consultationState?.sessionStatus"
          >
            {{ getSessionStatusText() }}
          </span>
          <span class="connection-quality">
            {{ getConnectionQualityIcon() }}
          </span>
          <span class="duration" *ngIf="consultationDuration">
            {{ consultationDuration }}
          </span>
        </div>
      </div>

      <div class="header-right">
        <div
          class="participant-count"
          *ngIf="consultationState?.participantCount"
        >
          👥 {{ consultationState?.participantCount }}
        </div>
        <button class="btn btn-danger" (click)="endConsultation()">
          End Consultation
        </button>
        <button class="btn btn-secondary" (click)="leaveConsultation()">
          Leave
        </button>
      </div>
    </header>

    <!-- Waiting Room Alert -->
    <div *ngIf="showWaitingRoomAlert" class="waiting-room-alert">
      <div class="alert-content">
        <div class="alert-icon">🚪</div>
        <div class="alert-text">
          <h4>Patient waiting in waiting room</h4>
          <p *ngIf="consultationState?.waitingRoomStatus?.waitingCount">
            {{ consultationState?.waitingRoomStatus?.waitingCount }} patient(s)
            waiting
          </p>
        </div>
        <div class="alert-actions">
          <button class="btn btn-primary" (click)="admitPatient()">
            Admit Patient
          </button>
          <button class="btn btn-ghost" (click)="dismissWaitingRoomAlert()">
            Dismiss
          </button>
        </div>
      </div>
    </div>

    <!-- Main Content Area -->
    <div class="consultation-content">
      <!-- Video Area -->
      <div class="video-section">
        <div class="video-container">
          <!-- Local Video (Practitioner) -->
          <div class="video-stream local-video">
            <video #videoElement autoplay muted playsinline></video>
            <div class="video-overlay">
              <span class="participant-name">You (Dr.)</span>
              <div class="video-controls-overlay">
                <button
                  class="video-control-btn"
                  [class.active]="isVideoEnabled"
                  (click)="toggleVideo()"
                  [disabled]="!areMediaControlsEnabled()"
                >
                  {{ isVideoEnabled ? "📹" : "🚫📹" }}
                </button>
                <button
                  class="video-control-btn"
                  [class.active]="isAudioEnabled"
                  (click)="toggleAudio()"
                  [disabled]="!areMediaControlsEnabled()"
                >
                  {{ isAudioEnabled ? "🎤" : "🚫🎤" }}
                </button>
              </div>
            </div>
          </div>

          <!-- Remote Video (Patient) -->
          <div
            class="video-stream remote-video"
            *ngIf="consultationState?.patientPresent"
          >
            <div class="patient-video-placeholder">
              <div class="placeholder-content">
                <div class="patient-avatar">👤</div>
                <h4>{{ consultationState?.patientName || "Patient" }}</h4>
                <p *ngIf="consultationState?.patientLanguage">
                  Language: {{ consultationState?.patientLanguage }}
                </p>
              </div>
            </div>
          </div>

          <!-- Waiting for Patient -->
          <div
            class="patient-waiting"
            *ngIf="
              !consultationState?.patientPresent &&
              consultationState?.sessionStatus === 'waiting'
            "
          >
            <div class="waiting-content">
              <div class="waiting-icon">⏳</div>
              <h3>Waiting for patient to join</h3>
              <p>
                The patient will appear here once they join the consultation
              </p>
            </div>
          </div>
        </div>

        <!-- Media Controls -->
        <div class="media-controls">
          <button
            class="control-btn video-btn"
            [class.active]="isVideoEnabled"
            (click)="toggleVideo()"
            [disabled]="!areMediaControlsEnabled()"
          >
            <span class="icon">{{ isVideoEnabled ? "📹" : "🚫📹" }}</span>
            <span class="label">Video</span>
          </button>

          <button
            class="control-btn audio-btn"
            [class.active]="isAudioEnabled"
            (click)="toggleAudio()"
            [disabled]="!areMediaControlsEnabled()"
          >
            <span class="icon">{{ isAudioEnabled ? "🎤" : "🚫🎤" }}</span>
            <span class="label">Audio</span>
          </button>

          <button
            class="control-btn screen-btn"
            [class.active]="isScreenSharing"
            (click)="startScreenShare()"
            [disabled]="!areMediaControlsEnabled()"
          >
            <span class="icon">🖥️</span>
            <span class="label">Share Screen</span>
          </button>

          <button class="control-btn end-btn" (click)="endConsultation()">
            <span class="icon">📞</span>
            <span class="label">End Call</span>
          </button>
        </div>
      </div>

      <!-- Sidebar -->
      <div class="sidebar">
        <!-- Participants Panel -->
        <div class="sidebar-panel participants-panel">
          <h3>Participants ({{ participants.length }})</h3>
          <div class="participants-list">
            <div
              class="participant-item"
              *ngFor="let participant of participants"
            >
              <div class="participant-avatar">
                {{ participant.firstName ? participant.firstName.charAt(0) : "?" }}
              </div>
              <div class="participant-info">
                <div class="participant-name">
                  {{ getParticipantName(participant) }}
                </div>
                <div class="participant-status">
                  <span class="role">{{ participant.role }}</span>
                  <span class="status" [class.active]="participant.isActive">
                    {{ participant.isActive ? "🟢 Active" : "⚫ Inactive" }}
                  </span>
                  <span class="waiting-room" *ngIf="participant.inWaitingRoom">
                    🚪 Waiting
                  </span>
                </div>
              </div>
              <div class="participant-media" *ngIf="participant.mediaStatus">
                <span
                  class="media-icon"
                  [class.disabled]="!participant.mediaStatus.videoEnabled"
                >
                  📹
                </span>
                <span
                  class="media-icon"
                  [class.disabled]="!participant.mediaStatus.audioEnabled"
                >
                  🎤
                </span>
              </div>
            </div>
          </div>
        </div>

        <!-- Chat Panel -->
        <div class="sidebar-panel chat-panel">
          <h3>Chat</h3>

          <!-- Chat Messages -->
          <div #chatContainer class="chat-messages">
            <div
              class="message"
              *ngFor="let message of chatMessages"
              [class.own-message]="message.isFromPractitioner"
            >
              <div class="message-header">
                <span class="message-author">{{ message.userName }}</span>
                <span class="message-time">{{
                  formatMessageTime(message.createdAt)
                }}</span>
              </div>
              <div class="message-content">{{ message.content }}</div>
            </div>

            <div *ngIf="chatMessages.length === 0" class="no-messages">
              No messages yet. Start the conversation!
            </div>
          </div>

          <!-- Chat Input -->
          <div class="chat-input" *ngIf="isConsultationActive()">
            <input
              type="text"
              [(ngModel)]="newMessage"
              (keyup.enter)="sendMessage()"
              placeholder="Type a message..."
              class="message-input"
            />
            <button
              class="send-btn"
              (click)="sendMessage()"
              [disabled]="!newMessage.trim()"
            >
              Send
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Status Bar -->
    <div class="status-bar">
      <div class="status-left">
        <span class="connection-status">
          {{
            consultationState?.isConnected ? "🟢 Connected" : "🔴 Disconnected"
          }}
        </span>
        <span class="media-status" *ngIf="mediaSessionState?.canJoinMedia">
          🎥 Media Ready
        </span>
      </div>

      <div class="status-right">
        <span class="session-info" *ngIf="consultationState?.consultationId">
          Session ID: {{ consultationState?.consultationId }}
        </span>
      </div>
    </div>
  </div>
</div>